var db = require("base/dbmanager");
var PRIZE = {
    0:8,
    1:18,
    2:28,
    3:38,
    4:48,
    5:58,
    6:88,
    7:188,
    8:288,
    9:388,
    10:688,
    11:999
}
function run(data,ws) {
    var userId = ws.userId;
    if(ws.isLottery) {
        response(null,ws);
        return;
    }
    if(userId != null) {
        var sql = "select cardNumber from users where id=?";
        db.query(sql,[userId],function (err,rows) {
            if(err) {
                console.log(err);
                return;
            }
            if(rows[0].cardNumber<20) {
                response({
                    type:"no_money"
                })
            }
            else {
                sql = "select lastLottery from users where id = ?";
                var parameter = [userId];
                db.query(sql,parameter,function(err,rows,fields) {
                    if(err != null) {
                        console.log(err);
                        return;
                    }
                    else {
                        var lastLotteryDate = rows[0].lastLottery;
                        if(lastLotteryDate == null) {
                            lottery(ws);
                            ws.isLottery = true;
                        }
                        else{
                            var sql = " select DATEDIFF(now(),?) as last";
                            parameter=[lastLotteryDate];
                            db.query(sql,parameter,function(err,rows) {
                                if(err != null) {
                                    console.log(err);
                                    return;
                                }
                                if(rows[0].last>=0) {
                                    lottery(ws);
                                }
                                else {
                                    ws.isLottery = true;
                                    response(null,ws);
                                }
                            });
                        }
                    }
                });
            }
        })

    }
}
function random() {
    var random = Math.random()*100;
    var prize = 0;
    if(random < 30) {

    }
    else if(random<40) {
        prize = 1;
    }else if(random<50) {
        prize = 2;
    }
    else if(random<60) {
        prize = 3;
    }
    else if(random<70) {
        prize = 4;
    }
    else if(random<80) {
        prize = 5;
    }
    else if(random<85) {
        prize = 6;
    }
    else if(random<90) {
        prize = 7;
    }
    else if(random<93) {
        prize = 8;
    }
    else if(random<96) {
        prize = 9;
    }
    else if(random<98) {
        prize = 10;
    }
    else if(random<99) {
        prize = 11;
    }
    return prize;
}
function lottery(ws) {
    var type = random();
    var zhuan = PRIZE[type];
    var sql = "update users set cardNumber=cardNumber+? where id=?";
    var parameter = [zhuan,ws.userId];
    db.query(sql,parameter,function (err,rows) {
        if(err != null) {
            console.log(err)
            return;
        }
        response({type:"zhuan",value:zhuan-20},ws);
    });
}
function response(data,ws) {
    if(data != null) {
        data.action = "lottery_result"
        setTimeout(function () {
            ws.send(JSON.stringify(data));
        },3000);
    }
    else {
        var info = {
            action:"lottery_result",
            type:false
        };
        ws.send(JSON.stringify(info));
    }
}
module.exports.run = run;