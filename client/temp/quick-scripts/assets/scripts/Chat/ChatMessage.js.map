{"version":3,"sources":["ChatMessage.js"],"names":["ChatMessage","cc","Class","extends","Component","properties","richText","RichText","spriteBackground","Sprite","emoji","Node","onLoad","instances","setString","string","autoHide","length","node","active","maxWidth","realStr","parseString","contentWidth","getContentSize","width","height","_hideNode","showEmoji","sprite","btnSprites","getComponent","spriteFrame","unscheduleAllCallbacks","scheduleOnce","bind","setEmoji","str","result","replace","match","bq","module","exports"],"mappings":"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","file":"ChatMessage.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\Chat","sourcesContent":["// 用于在游戏过程中，展示用户的聊天消息\n\nlet ChatMessage = cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        richText: cc.RichText,\n        spriteBackground: cc.Sprite,\n        emoji:cc.Node,\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        ChatMessage.instances = this;\n    },\n\n    setString: function (string = \"\", autoHide = true) {\n        if (string.length == 0) {\n            return;\n        }\n\n        this.node.active = true;\n        this.richText.node.active = true;\n        this.spriteBackground.node.active = true;\n        this.emoji.active = false;\n        let maxWidth = 300;\n        let realStr = ChatMessage.parseString(string);\n\n        // 由于 cc.RichText 在指定 maxWidth 后，该结点的 width 会一直\n        // 是 maxWidth 值。而在将 maxWidth 指定为0时，其 contentSize.width 会\n        // 是内容的真正所需的宽度\n        //\n        // 所以这里先将 maxWidth 设为 0，获取其实际内容 width 后再调整\n        this.richText.maxWidth = 0;\n        this.richText.string = realStr;\n\n        let contentWidth = this.richText.node.getContentSize().width;\n        if (contentWidth > maxWidth) {\n            this.richText.maxWidth = maxWidth;\n            this.richText.string = realStr;\n            contentWidth = maxWidth;\n        }\n\n        this.node.width = contentWidth + 28;\n        this.node.height = this.richText.node.getContentSize().height + 20;\n\n        this.spriteBackground.node.width = this.node.width;\n        this.spriteBackground.node.height = this.node.height;\n\n        if (autoHide) {\n            this._hideNode()\n            //this.unscheduleAllCallbacks();\n            //this.scheduleOnce(this._hideNode.bind(this), 3);\n        }\n    },\n\n    showEmoji: function (sprite) {\n        this._hideNode();\n        this.node.active = true;\n        this.emoji.active = true;\n        this.richText.node.active = false;\n        this.spriteBackground.node.active = false;\n        var btnSprites =  this.emoji.getComponent(cc.Sprite);\n        btnSprites.spriteFrame = sprite;\n    },\n\n    _hideNode: function () {\n        this.unscheduleAllCallbacks();\n        this.scheduleOnce(function(){\n            this.node.active = false;\n        }.bind(this), 3);\n    },\n\n});\nChatMessage.setEmoji = function(sprite){\n    this.instances._hideNode();\n    this.instances.node.active = true;\n    this.instances.emoji.active = true;\n    this.instances.richText.node.active = false;\n    this.instances.spriteBackground.node.active = false;\n    var btnSprites =  this.instances.emoji.getComponent(cc.Sprite);\n    btnSprites.spriteFrame = sprite;\n    //console.log(this.emoji);\n    //return;\n    //\n    //this.emoji.Sprite = sprite;\n},\n\n// 将 <bq10> 改为： <img src='bg10'/>\nChatMessage.parseString = function (str) {\n    let result = str.replace(/<bq\\d{1,2}>/g, function(match){\n        var bq = match.replace(\"<\", \" <img src='\").replace(\">\", \"'/> \");\n        return bq;\n    });\n    return result;\n},\n\nmodule.exports = ChatMessage;\n"]}