{"version":3,"sources":["MsgControl.js"],"names":["Socket","require","ChatMessage","AudioManager","cc","Class","extends","Component","properties","textScrollView","Node","imageContentNode","editBox","EditBox","textRecordScrollView","ScrollView","textRecordLayout","Layout","textPrefab","Prefab","chatTextRecordPrefab","emojiPrefab","biaoqing","kuaijieyu","content","inputNode","emoji","_userId","_playerInfos","_chatTextMessageRecords","onLoad","instance","userInfo","id","textContent","getComponent","self","textData","chatTexts","i","length","item","instantiate","setText","onSelectAction","text","onTextClickAction","h","addChild","clickKuaiJieYu","active","clickBiaoQing","string","sendText","clickEmoji","event","emojiName","sendEmoji","clickSend","dismiss","node","bqAction","bqNode1","btnLanguageNode","btnChartNode1","bqNode","btnLanguageNode1","btnChartNode","textAction","chartAction","addPlayerInfos","playerInfos","forEach","haveUserInfo","find","ownUserInfo","push","bind","addChatTextMessage","userId","nickname","str","parseString","_addChatTextToRecord","addChatEmojiMessage","_addChatEmojiToRecord","_loadEmojiFrame","frame","setEmoji","Emojiname","callback","loader","loadRes","SpriteAtlas","err","atlas","getSpriteFrame","chatTextRecord","setString","scrollToBottom"],"mappings":";;;;;;AAAA,IAAMA,SAASC,QAAQ,QAAR,CAAf;AACA,IAAMC,cAAcD,QAAQ,aAAR,CAApB;AACA,IAAME,eAAeF,QAAQ,cAAR,CAArB;;AAEA;AACAG,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACR;AACA;AACA;AACA;AACA;AACA;AACAC,wBAAeL,GAAGM,IAPV;AAQRC,0BAAiBP,GAAGM,IARZ;;AAURE,iBAASR,GAAGS,OAVJ;;AAYRC,8BAAsBV,GAAGW,UAZjB;AAaRC,0BAAkBZ,GAAGa,MAbb;;AAeRC,oBAAWd,GAAGe,MAfN;AAgBRC,8BAAsBhB,GAAGe,MAhBjB;AAiBRE,qBAAYjB,GAAGe,MAjBP;AAkBR;;AAEAG,kBAAU,CAAClB,GAAGM,IAAJ,CApBF,EAoBgB;AACxBa,mBAAW,CAACnB,GAAGM,IAAJ,CArBH,EAqBgB;AACxBc,iBAAQ,CAACpB,GAAGM,IAAJ,CAtBA,EAsBgB;AACxBe,mBAAUrB,GAAGM,IAvBL;AAwBRgB,eAAM,CAACtB,GAAGM,IAAJ,CAxBE;AAyBRiB,iBAAS,IAzBD;;AA2BRC,sBAAc,IA3BN,EA2BmB;AAC3BC,iCAAyB,IA5BjB,CA4BuB;AA5BvB,KAHP;;AAkCL;AACAC,YAAQ,kBAAY;AAChB,aAAKH,OAAL,GAAe3B,OAAO+B,QAAP,CAAgBC,QAAhB,CAAyBC,EAAxC;AACA,aAAKL,YAAL,GAAoB,EAApB;AACA,aAAKM,WAAL,GAAmB,KAAKzB,cAAL,CAAoB0B,YAApB,CAAiC/B,GAAGW,UAApC,EAAgDS,OAAnE;AACA;AACA,YAAIY,OAAO,IAAX;AACA,YAAIC,WAAWlC,aAAa4B,QAAb,CAAsBO,SAAtB,EAAf;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,SAASG,MAA7B,EAAqCD,GAArC,EAA0C;AACtC,gBAAIE,OAAOrC,GAAGsC,WAAH,CAAe,KAAKxB,UAApB,CAAX;AACAuB,iBAAKN,YAAL,CAAkB,UAAlB,EAA8BQ,OAA9B,CAAsCN,SAASE,CAAT,CAAtC;AACAE,iBAAKN,YAAL,CAAkB,UAAlB,EAA8BS,cAA9B,GAA+C,UAASC,IAAT,EAAe;AAC1DT,qBAAKU,iBAAL,CAAuBD,IAAvB;AACH,aAFD;AAGA,iBAAKX,WAAL,CAAiBa,CAAjB,GAAqB,IAArB;AACA,iBAAKb,WAAL,CAAiBc,QAAjB,CAA0BP,IAA1B;AACH;AAEJ,KApDI;;AAuDLQ,oBAAgB,0BAAU;AACtB,aAAK1B,SAAL,CAAe,CAAf,EAAkB2B,MAAlB,GAA2B,IAA3B,CADsB,CACc;AACpC,aAAK3B,SAAL,CAAe,CAAf,EAAkB2B,MAAlB,GAA2B,KAA3B,CAFsB,CAEc;AACpC,aAAK5B,QAAL,CAAc,CAAd,EAAiB4B,MAAjB,GAA0B,KAA1B,CAHsB,CAGc;AACpC,aAAK5B,QAAL,CAAc,CAAd,EAAiB4B,MAAjB,GAA0B,IAA1B,CAJsB,CAIc;AACpC,aAAK1B,OAAL,CAAa,CAAb,EAAgB0B,MAAhB,GAAyB,IAAzB;AACA,aAAK1B,OAAL,CAAa,CAAb,EAAgB0B,MAAhB,GAAyB,KAAzB;AACH,KA9DI;AA+DLC,mBAAe,yBAAU;AACrB,aAAK7B,QAAL,CAAc,CAAd,EAAiB4B,MAAjB,GAA0B,IAA1B,CADqB,CACe;AACpC,aAAK5B,QAAL,CAAc,CAAd,EAAiB4B,MAAjB,GAA0B,KAA1B,CAFqB,CAEe;AACpC,aAAK3B,SAAL,CAAe,CAAf,EAAkB2B,MAAlB,GAA2B,KAA3B,CAHqB,CAGe;AACpC,aAAK3B,SAAL,CAAe,CAAf,EAAkB2B,MAAlB,GAA2B,IAA3B,CAJqB,CAIe;AACpC,aAAK1B,OAAL,CAAa,CAAb,EAAgB0B,MAAhB,GAAyB,KAAzB;AACA,aAAK1B,OAAL,CAAa,CAAb,EAAgB0B,MAAhB,GAAyB,IAAzB;AACH,KAtEI;AAuELJ,uBAAkB,6BAAoB;AAAA,YAAXD,IAAW,uEAAJ,EAAI;;AAClC,aAAKjC,OAAL,CAAawC,MAAb,GAAsB,EAAtB;AACA,aAAKC,QAAL,CAAcR,IAAd;AACH,KA1EI;;AA4ELS,gBAAY,oBAAUC,KAAV,EAAiBC,SAAjB,EAA4B;AACpC,YAAIJ,SAAS,KAAKxC,OAAL,CAAawC,MAA1B;AACA,aAAKxC,OAAL,CAAawC,MAAb,GAAsBA,SAAS,GAAT,GAAeI,SAAf,GAA2B,GAAjD;AACA,aAAKC,SAAL,CAAeD,SAAf;AACH,KAhFI;;AAkFLE,eAAW,qBAAY;AACnB,YAAIN,SAAS,KAAKxC,OAAL,CAAawC,MAAb,IAAuB,EAApC;AACA,YAAIA,OAAOZ,MAAP,IAAiB,CAArB,EAAwB;AACpB;AACH;AACD,aAAK5B,OAAL,CAAawC,MAAb,GAAsB,EAAtB;AACA,aAAKC,QAAL,CAAcD,MAAd;AACH,KAzFI;;AA2FLK,eAAW,mBAASD,SAAT,EAAmB;AAC1B,YAAGA,UAAUhB,MAAV,IAAmB,CAAtB,EAAwB;AACpB;AACH;AACDxC,eAAOyD,SAAP,CAAiB,KAAK9B,OAAtB,EAA+B6B,SAA/B;AACA,aAAKG,OAAL;AACH,KAjGI;;AAmGLN,cAAU,oBAAqB;AAAA,YAAXR,IAAW,uEAAJ,EAAI;;AAC3B,YAAIA,KAAKL,MAAL,IAAe,CAAnB,EAAsB;AAClB;AACH;AACDxC,eAAOqD,QAAP,CAAgB,KAAK1B,OAArB,EAA8BkB,IAA9B;AACA,aAAKc,OAAL;AACH,KAzGI;;AA2GLA,aAAS,mBAAY;AACjB,aAAKC,IAAL,CAAUV,MAAV,GAAmB,KAAnB;AACH,KA7GI;;AA+GLW,cAAS,oBAAW;AAChB,aAAKC,OAAL,CAAaZ,MAAb,GAAsB,KAAKa,eAAL,CAAqBb,MAArB,GAA8B,KAAKc,aAAL,CAAmBd,MAAnB,GAA4B,IAAhF;AACA,aAAKe,MAAL,CAAYf,MAAZ,GAAqB,KAAKgB,gBAAL,CAAsBhB,MAAtB,GAA+B,KAAKiB,YAAL,CAAkBjB,MAAlB,GAA2B,KAA/E;AACA,aAAKzC,cAAL,CAAoByC,MAApB,GAA6B,KAA7B;AACA,aAAKvC,gBAAL,CAAsBuC,MAAtB,GAA+B,IAA/B;AACA,aAAKpC,oBAAL,CAA0B8C,IAA1B,CAA+BV,MAA/B,GAAwC,KAAxC;AACH,KArHI;;AAuHLkB,gBAAW,sBAAW;AAClB,aAAKN,OAAL,CAAaZ,MAAb,GAAsB,KAAKa,eAAL,CAAqBb,MAArB,GAA8B,KAAKiB,YAAL,CAAkBjB,MAAlB,GAA2B,KAA/E;AACA,aAAKe,MAAL,CAAYf,MAAZ,GAAqB,KAAKgB,gBAAL,CAAsBhB,MAAtB,GAA+B,KAAKc,aAAL,CAAmBd,MAAnB,GAA4B,IAAhF;AACA,aAAKzC,cAAL,CAAoByC,MAApB,GAA6B,IAA7B;AACA,aAAKvC,gBAAL,CAAsBuC,MAAtB,GAA+B,KAA/B;AACA,aAAKpC,oBAAL,CAA0B8C,IAA1B,CAA+BV,MAA/B,GAAwC,KAAxC;AACH,KA7HI;;AA+HLmB,iBAAY,uBAAW;AACnB,aAAKP,OAAL,CAAaZ,MAAb,GAAsB,KAAKgB,gBAAL,CAAsBhB,MAAtB,GAA+B,KAAKc,aAAL,CAAmBd,MAAnB,GAA4B,KAAjF;AACA,aAAKe,MAAL,CAAYf,MAAZ,GAAqB,KAAKa,eAAL,CAAqBb,MAArB,GAA8B,KAAKiB,YAAL,CAAkBjB,MAAlB,GAA2B,IAA9E;AACA,aAAKzC,cAAL,CAAoByC,MAApB,GAA6B,KAAKvC,gBAAL,CAAsBuC,MAAtB,GAA+B,KAA5D;AACA,aAAKpC,oBAAL,CAA0B8C,IAA1B,CAA+BV,MAA/B,GAAwC,IAAxC;AACH,KApII;;AAsILoB,oBAAgB,wBAAUC,WAAV,EAAuB;AACnC,aAAK3C,YAAL,GAAoB,KAAKA,YAAL,IAAqB,EAAzC;;AAEA2C,oBAAYC,OAAZ,CAAoB,UAAUxC,QAAV,EAAoB;AACpC,gBAAIyC,eAAe,KAAK7C,YAAL,CAAkB8C,IAAlB,CAAuB,UAAUC,WAAV,EAAuB;AAC7D,uBAAOA,YAAY1C,EAAZ,IAAkBD,SAASC,EAAlC;AACH,aAFkB,CAAnB;;AAIA,gBAAIwC,gBAAgB,IAApB,EAA0B;AACtB,qBAAK7C,YAAL,CAAkBgD,IAAlB,CAAuB5C,QAAvB;AACH;AACJ,SARmB,CAQlB6C,IARkB,CAQb,IARa,CAApB;AASH,KAlJI;;AAoJLC,wBAAoB,4BAAUC,MAAV,EAAkBlC,IAAlB,EAAwB;AACxC,aAAKjB,YAAL,GAAoB,KAAKA,YAAL,IAAqB,EAAzC;;AAEA,YAAIoD,WAAW,SAASD,MAAT,GAAkB,KAAjC;AACA,YAAI/C,WAAW,KAAKJ,YAAL,CAAkB8C,IAAlB,CAAuB,UAAU1C,QAAV,EAAoB;AACtD,mBAAOA,SAASC,EAAT,IAAe8C,MAAtB;AACH,SAFc,CAAf;;AAIA,YAAI/C,QAAJ,EAAc;AACVgD,uBAAW,MAAMhD,SAASgD,QAAf,GAA0B,KAArC;AACH;;AAED,YAAIC,MAAMD,WAAWnC,IAArB;AACAoC,cAAM/E,YAAYgF,WAAZ,CAAwBD,GAAxB,CAAN;AACA,aAAKE,oBAAL,CAA0BF,GAA1B;AACH,KAnKI;;AAqKLG,yBAAoB,6BAASL,MAAT,EAAgBrD,KAAhB,EAAsB;AACtC,aAAKE,YAAL,GAAoB,KAAKA,YAAL,IAAqB,EAAzC;;AAEA,YAAIoD,WAAW,SAASD,MAAT,GAAkB,KAAjC;AACA,YAAI/C,WAAW,KAAKJ,YAAL,CAAkB8C,IAAlB,CAAuB,UAAU1C,QAAV,EAAoB;AACtD,mBAAOA,SAASC,EAAT,IAAe8C,MAAtB;AACH,SAFc,CAAf;AAGA,YAAI/C,QAAJ,EAAc;AACVgD,uBAAW,MAAMhD,SAASgD,QAAf,GAA0B,KAArC;AACH;AACD,YAAIC,MAAMD,WAAWtD,KAArB;AACAuD,cAAM/E,YAAYgF,WAAZ,CAAwBD,GAAxB,CAAN;AACA,aAAKI,qBAAL,CAA2B3D,KAA3B;AACA;AACA;AACH,KApLI;;AAsLL2D,2BAAsB,+BAAS3D,KAAT,EAAe;AACjC,YAAIU,OAAO,IAAX;AACA,aAAKkD,eAAL,CAAqB5D,KAArB,EAA2B,UAAS6D,KAAT,EAAe;AACtC;AACA;AACA;AACA;AACA;AACA;AACArF,wBAAYsF,QAAZ,CAAqBD,KAArB;AAEH,SATD;AAUH,KAlMI;;AAoMLD,qBAAiB,yBAASG,SAAT,EAAoBC,QAApB,EAA6B;AAC1CtF,WAAGuF,MAAH,CAAUC,OAAV,CAAkB,mBAAlB,EAAuCxF,GAAGyF,WAA1C,EAAuD,UAAUC,GAAV,EAAeC,KAAf,EAAsB;AACzE,gBAAGD,GAAH,EAAO;AACH;AACA;AACH;AACD,gBAAIP,QAAQQ,MAAMC,cAAN,CAAqBP,SAArB,CAAZ;AACAC,qBAASH,KAAT;AACH,SAPsD,CAOrDV,IAPqD,CAOhD,IAPgD,CAAvD;AASH,KA9MI;;AAgNLM,0BAAsB,8BAAUtC,IAAV,EAAgB;AAClC,YAAIJ,OAAOrC,GAAGsC,WAAH,CAAe,KAAKtB,oBAApB,CAAX;AACA,YAAI6E,iBAAiBxD,KAAKN,YAAL,CAAkB,gBAAlB,CAArB;AACA8D,uBAAeC,SAAf,CAAyBrD,IAAzB;;AAEA,aAAK7B,gBAAL,CAAsB4C,IAAtB,CAA2BZ,QAA3B,CAAoCP,IAApC;AACA,aAAK3B,oBAAL,CAA0BqF,cAA1B;AACH;AAvNI,CAAT","file":"MsgControl.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\Chat","sourcesContent":["const Socket = require('socket');\nconst ChatMessage = require('ChatMessage');\nconst AudioManager = require('AudioManager');\n\n// 用来发送消息的 component\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        //bqNode:cc.Node,\n        //bqNode1:cc.Node,\n        //btnLanguageNode:cc.Node,\n        //btnLanguageNode1:cc.Node,\n        //btnChartNode:cc.Node,\n        //btnChartNode1:cc.Node,\n        textScrollView:cc.Node,\n        imageContentNode:cc.Node,\n\n        editBox: cc.EditBox,\n\n        textRecordScrollView: cc.ScrollView,\n        textRecordLayout: cc.Layout,\n\n        textPrefab:cc.Prefab,\n        chatTextRecordPrefab: cc.Prefab,\n        emojiPrefab:cc.Prefab,\n        // imagePrefab:cc.Prefab,\n\n        biaoqing: [cc.Node],    // [亮的背景, 暗的背景]   快捷语\n        kuaijieyu: [cc.Node],   // [亮的背景, 暗的背景]   表情\n        content:[cc.Node],      // [快捷语, 表情]   \n        inputNode:cc.Node,\n        emoji:[cc.Node],\n        _userId: null,\n\n        _playerInfos: null,        // 记录用户信息\n        _chatTextMessageRecords: null, // 聊天文本消息记录\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        this._userId = Socket.instance.userInfo.id;\n        this._playerInfos = [];\n        this.textContent = this.textScrollView.getComponent(cc.ScrollView).content;\n        // this.imageContent = this.imageScrollView.getComponent(cc.ScrollView).content;\n        var self = this;\n        var textData = AudioManager.instance.chatTexts();\n        for (var i = 0; i < textData.length; i++) {\n            var item = cc.instantiate(this.textPrefab);\n            item.getComponent('cellText').setText(textData[i]);\n            item.getComponent('cellText').onSelectAction = function(text) {\n                self.onTextClickAction(text);\n            };\n            this.textContent.h = 1000;\n            this.textContent.addChild(item);\n        }\n\n    },\n\n\n    clickKuaiJieYu :function(){\n        this.kuaijieyu[0].active = true;    // 快捷语 背景\n        this.kuaijieyu[1].active = false;   // 快捷语 按钮\n        this.biaoqing[0].active = false;    // 背景表情\n        this.biaoqing[1].active = true;     // 表情按钮\n        this.content[0].active = true;\n        this.content[1].active = false;\n    },\n    clickBiaoQing :function(){\n        this.biaoqing[0].active = true;     // 背景表情\n        this.biaoqing[1].active = false;    // 表情按钮\n        this.kuaijieyu[0].active = false;   // 快捷语 背景\n        this.kuaijieyu[1].active = true ;   // 快捷语 按钮\n        this.content[0].active = false;\n        this.content[1].active = true;\n    },\n    onTextClickAction:function(text = \"\") {\n        this.editBox.string = \"\";\n        this.sendText(text);\n    },\n\n    clickEmoji: function (event, emojiName) {\n        let string = this.editBox.string;\n        this.editBox.string = string + \"<\" + emojiName + \">\";\n        this.sendEmoji(emojiName);\n    },\n\n    clickSend: function () {\n        let string = this.editBox.string || \"\";\n        if (string.length == 0) {\n            return;\n        }\n        this.editBox.string = \"\";\n        this.sendText(string);\n    },\n\n    sendEmoji :function(emojiName){\n        if(emojiName.length ==0){\n            return\n        }\n        Socket.sendEmoji(this._userId, emojiName);\n        this.dismiss();\n    },\n\n    sendText: function (text = \"\") {\n        if (text.length == 0) {\n            return;\n        }\n        Socket.sendText(this._userId, text);\n        this.dismiss();\n    },\n\n    dismiss: function () {\n        this.node.active = false;\n    },\n\n    bqAction:function() {\n        this.bqNode1.active = this.btnLanguageNode.active = this.btnChartNode1.active = true;\n        this.bqNode.active = this.btnLanguageNode1.active = this.btnChartNode.active = false;\n        this.textScrollView.active = false;\n        this.imageContentNode.active = true;\n        this.textRecordScrollView.node.active = false;\n    },\n\n    textAction:function() {\n        this.bqNode1.active = this.btnLanguageNode.active = this.btnChartNode.active = false;\n        this.bqNode.active = this.btnLanguageNode1.active = this.btnChartNode1.active = true;\n        this.textScrollView.active = true;\n        this.imageContentNode.active = false;\n        this.textRecordScrollView.node.active = false;\n    },\n\n    chartAction:function() {\n        this.bqNode1.active = this.btnLanguageNode1.active = this.btnChartNode1.active = false;\n        this.bqNode.active = this.btnLanguageNode.active = this.btnChartNode.active = true;\n        this.textScrollView.active = this.imageContentNode.active = false;\n        this.textRecordScrollView.node.active = true;\n    },\n\n    addPlayerInfos: function (playerInfos) {\n        this._playerInfos = this._playerInfos || [];\n\n        playerInfos.forEach(function (userInfo) {\n            let haveUserInfo = this._playerInfos.find(function (ownUserInfo) {\n                return ownUserInfo.id == userInfo.id;\n            });\n\n            if (haveUserInfo == null) {\n                this._playerInfos.push(userInfo);\n            }\n        }.bind(this));\n    },\n\n    addChatTextMessage: function (userId, text) {\n        this._playerInfos = this._playerInfos || [];\n\n        var nickname = \"[ID:\" + userId + \"说]：\";\n        let userInfo = this._playerInfos.find(function (userInfo) {\n            return userInfo.id == userId;\n        });\n\n        if (userInfo) {\n            nickname = \"[\" + userInfo.nickname + \"说]：\";\n        }\n\n        var str = nickname + text;\n        str = ChatMessage.parseString(str);\n        this._addChatTextToRecord(str);\n    },\n\n    addChatEmojiMessage:function(userId,emoji){\n        this._playerInfos = this._playerInfos || [];\n\n        var nickname = \"[ID:\" + userId + \"说]：\";\n        let userInfo = this._playerInfos.find(function (userInfo) {\n            return userInfo.id == userId;\n        });\n        if (userInfo) {\n            nickname = \"[\" + userInfo.nickname + \"说]：\";\n        };\n        var str = nickname + emoji;\n        str = ChatMessage.parseString(str);\n        this._addChatEmojiToRecord(emoji);\n        // cc.log(emoji)\n        // cc.log('---190')\n    },\n\n    _addChatEmojiToRecord:function(emoji){\n        var self = this;\n        this._loadEmojiFrame(emoji,function(frame){\n            //var item  = cc.instantiate(self.emojiPrefab);\n            //cc.log(frame)\n            //var btnSprites =  item.getComponent(cc.Sprite);\n            //btnSprites.spriteFrame = frame;\n            //let chatEmojiRecord = item.getComponent('ChatTextRecord');\n            //chatEmojiRecord.setEmoji(frame);\n            ChatMessage.setEmoji(frame);\n\n        })\n    },\n\n    _loadEmojiFrame :function(Emojiname ,callback){\n        cc.loader.loadRes(\"/textures/chat/bq\", cc.SpriteAtlas, function (err, atlas) {\n            if(err){\n                //console.log(null, err)\n                return;\n            }\n            var frame = atlas.getSpriteFrame(Emojiname);\n            callback(frame);\n        }.bind(this))\n\n    },\n\n    _addChatTextToRecord: function (text) {\n        var item = cc.instantiate(this.chatTextRecordPrefab);\n        let chatTextRecord = item.getComponent('ChatTextRecord');\n        chatTextRecord.setString(text);\n\n        this.textRecordLayout.node.addChild(item);\n        this.textRecordScrollView.scrollToBottom();\n    },\n});\n"]}